<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Sign in • EC2 Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root{ --bg:#0e1624; --panel:#121b2b; --ink:#e6e9ef; --mut:#9aa4b2; --ok:#2e9762; --bad:#b94a4a; --chip:#19243a }
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",sans-serif;display:flex;align-items:center;justify-content:center}
    .card{width:min(640px,92vw);background:var(--panel);border-radius:16px;padding:18px;box-shadow:0 0 0 1px #1c2840 inset}
    input{width:100%;background:#0f1a2e;border:1px solid #243355;color:#e6e9ef;border-radius:10px;padding:10px;margin-top:10px}
    .btn{margin-top:14px;width:100%;padding:12px;border-radius:10px;background:linear-gradient(90deg,#6aa8ff,#7affe3);border:0;color:#0e1624;font-weight:700;cursor:pointer}
    .mut{color:#9aa4b2;font-size:12px;margin-top:8px}
    .err{color:#ffb3bf;font-size:12px;margin-top:8px}
  </style>
</head>
<body>
  <div class="card">
    <div style="font-size:20px;font-weight:700">Complete your sign-in</div>
    <input id="u" placeholder="username" autocomplete="username" />
    <input id="p" placeholder="password" type="password" autocomplete="current-password" />
    <button class="btn" onclick="signin()">Sign in</button>
    <div id="msg" class="err"></div>
    <div class="mut">You’ve just verified your email OTP. If this page appeared without OTP, <a href="/" style="color:#8bc5ff">go back</a>.</div>
  </div>

<script>
(function(){
  // 1) read API base from storage (set by index.html.tpl)
  const API = localStorage.getItem("api_base_url") || "";

  // 2) get verified email from URL 'e' OR from storage (session first, then local)
  const qs = new URLSearchParams(location.search);
  const fromQS = (qs.get("e")||"").trim().toLowerCase();
  let otpEmail = fromQS || (sessionStorage.getItem("otp_email")||"").toLowerCase() || (localStorage.getItem("otp_email")||"").toLowerCase();

  // 3) if we found it in the URL, persist it to BOTH storages (covers new CF domains/tabs)
  if(fromQS){
    try { sessionStorage.setItem("otp_email", fromQS); localStorage.setItem("otp_email", fromQS); } catch(_) {}
  }

  // 4) show a nice message if still missing
  if(!otpEmail){
    document.getElementById("msg").textContent = "missing_verified_otp";
  }

  function http(path, method, obj){
    return fetch(API+path,{
      method,
      headers:{"content-type":"application/json"},
      body:JSON.stringify(obj||{})
    }).then(async r=>{
      const data = await r.json().catch(()=> ({}));
      if(!r.ok){ throw new Error((data && (data.error||data.message)) || ("http "+r.status)); }
      return data;
    });
  }

  // expose signin globally
  window.signin = function(){
    const username = document.getElementById("u").value.trim();
    const password = document.getElementById("p").value;
    const msg = document.getElementById("msg");
    msg.textContent = "";

    // if OTP email is missing, bounce to OTP page
    if(!otpEmail){
      msg.textContent = "missing_verified_otp";
      return;
    }

    http("/login","POST",{username,password,otp_email: otpEmail})
      .then(res=>{
        try{
          localStorage.setItem("jwt", res.jwt);
          localStorage.setItem("role", res.role||"");
          localStorage.setItem("user", JSON.stringify({username, role:res.role||"", name:res.name||""}));
        }catch(_){}
        location.href = "/";
      })
      .catch(e=>{ msg.textContent = e.message || "invalid_password"; });
  };
})();
</script>
</body>
</html>
